


##########
#	MIGRATION EFFECTS, the cornerstone of these mechanics. Hard to understand, but does wonders
##########

PG_update_inforange = {
	# Set main province's value, and compare
	export_to_variable = { which = tp_base value = province_trade_power } set_variable = { which = tp_compare which = tp_base }
	export_to_variable = { which = tp_infomod value = modifier:local_institution_spread } change_variable = { tp_infomod = 0.5 } # info: base -50%
	if = { limit = { check_variable = { tp_infomod = 0.9 } } set_variable = { which = tp_infomod value = 0.9 } } # max 90%, at least 10% attrition
	
	# Look at each of the neighbours values, and "compare" while updating
	every_neighbor_province = {
		export_to_variable = { which = tp_compare value = province_trade_power }  
		set_variable = { which = tp_infomod which = PREV } multiply_variable = { which = tp_compare which = tp_infomod } # use info % from base prov
		if = { limit = { check_variable = { which = tp_old which = tp_compare } } set_variable = { which = tp_compare which = tp_old } }
		if = {
			limit = { check_variable = { which = tp_compare which = PREV } }	# here which prev = the original province
			PREV = { set_variable = { which = tp_compare which = PREV } } 		# here which prev = the neighbor, so, moving the neighbors to you
		}
	}
	set_variable = { which = PG_info_range which = tp_compare } set_variable = { which = tp_old which = tp_compare }
	set_variable = { which = tp_infodisp which = tp_infomod } 	multiply_variable = { which = tp_old which = tp_infomod }
	# compare after passing all neighboring values (highest possible value). Final will be used for travel; old to check later on
	
}

PG_find_target_province = {
	if = {
		limit = { 
			any_province = {
				NOT = { province_distance = { who = PREV distance = $range$ } } check_variable = { urban_growth = 1.2 }
				NOT = { has_province_modifier = PG_new_pop }					province_has_center_of_trade_of_level = 2	# very high CoT
			}
		}
		random_province = {
			limit = {
				NOT = { province_distance = { who = PREV distance = $range$ } }	check_variable = { urban_growth = 1.2 }
				NOT = { has_province_modifier = PG_new_pop }					province_has_center_of_trade_of_level = 2
			}
			save_event_target_as = PG_target
		}
	}
	else_if = {
		limit = { 
			any_province = {
				NOT = { province_distance = { who = PREV distance = $range$ } } check_variable = { urban_growth = 1.2 }
				NOT = { has_province_modifier = PG_new_pop }					province_has_center_of_trade_of_level = 1	# "normal" CoT
			}
		}
		random_province = {
			limit = {
				NOT = { province_distance = { who = PREV distance = $range$ } }	check_variable = { urban_growth = 1.2 }
				NOT = { has_province_modifier = PG_new_pop }					province_has_center_of_trade_of_level = 1
			}
			save_event_target_as = PG_target
		}
	}
	else_if = {
		limit = { 
			any_province = {
				NOT = { province_distance = { who = PREV distance = $range$ } } NOT = { has_province_modifier = PG_new_pop } # any other place
				OR = { check_variable = { rural_growth = 1.2 } check_variable = { urban_growth = 1.2 } }
			}
		}
		random_province = {
			limit = {
				NOT = { province_distance = { who = PREV distance = $range$ } } NOT = { has_province_modifier = PG_new_pop }
				OR = { check_variable = { rural_growth = 1.2 } check_variable = { urban_growth = 1.2 } }			
			}
			save_event_target_as = PG_target
		}
	}
	else = { 	# nowhere to go -> starvation! 
		set_province_flag = PG_starvation_start
	}

}

mig_dist_cost = {
	if = { 		limit = { province_distance = { who = PREV distance = 1200 } } 	PREV = { owner = { add_treasury = -100 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 750 } } 	PREV = { owner = { add_treasury = -70 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 500 } } 	PREV = { owner = { add_treasury = -60 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 400 } } 	PREV = { owner = { add_treasury = -50 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 300 } } 	PREV = { owner = { add_treasury = -40 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 200 } } 	PREV = { owner = { add_treasury = -30 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 120 } } 	PREV = { owner = { add_treasury = -20 } } }
	else = { 																	PREV = { owner = { add_treasury = -10 } } }
	
}

mig_rural_to_urban = {
	PREV = { subtract_variable = { which = mig_size value = $no$ } add_base_manpower = -$no$ 	change_variable = { PS_rur_emig = $no$ } }
	add_base_production = $no$ 	add_province_modifier = { name = pg_new_pop duration = 365 }	change_variable = { PS_urb_imig = $no$ }
	
}

mig_rural_to_rural = {
	PREV = { subtract_variable = { which = mig_size value = $no$ } add_base_manpower = -$no$  	change_variable = { PS_rur_emig = $no$ } }
	add_base_manpower = $no$ 	add_province_modifier = { name = pg_new_pop duration = 365 }	change_variable = { PS_rur_imig = $no$ }
	
}






