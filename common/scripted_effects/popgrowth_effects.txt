

popgrowth_cleanup_world = {
	# General cleanup of the world variables
	
	# 1 to 5
	set_variable = { which = rural_now_01 value = 0 } set_variable = { which = urban_now_01 value = 0 } 
	set_variable = { which = upper_now_01 value = 0 } set_variable = { which = devel_now_01 value = 0 } 
	set_variable = { which = prov_size_01 value = 0 } set_variable = { which = total_cap_01 value = 0 } 
	set_variable = { which = rural_cap_01 value = 0 } set_variable = { which = urban_cap_01 value = 0 } 
	set_variable = { which = upper_cap_01 value = 0 } 
	
	set_variable = { which = rural_now_02 value = 0 } set_variable = { which = urban_now_02 value = 0 } 
	set_variable = { which = upper_now_02 value = 0 } set_variable = { which = devel_now_02 value = 0 } 
	set_variable = { which = prov_size_02 value = 0 } set_variable = { which = total_cap_02 value = 0 } 
	set_variable = { which = rural_cap_02 value = 0 } set_variable = { which = urban_cap_02 value = 0 } 
	set_variable = { which = upper_cap_02 value = 0 } 
	
	set_variable = { which = rural_now_03 value = 0 } set_variable = { which = urban_now_03 value = 0 } 
	set_variable = { which = upper_now_03 value = 0 } set_variable = { which = devel_now_03 value = 0 } 
	set_variable = { which = prov_size_03 value = 0 } set_variable = { which = total_cap_03 value = 0 } 
	set_variable = { which = rural_cap_03 value = 0 } set_variable = { which = urban_cap_03 value = 0 } 
	set_variable = { which = upper_cap_03 value = 0 } 
	
	set_variable = { which = rural_now_04 value = 0 } set_variable = { which = urban_now_04 value = 0 } 
	set_variable = { which = upper_now_04 value = 0 } set_variable = { which = devel_now_04 value = 0 } 
	set_variable = { which = prov_size_04 value = 0 } set_variable = { which = total_cap_04 value = 0 } 
	set_variable = { which = rural_cap_04 value = 0 } set_variable = { which = urban_cap_04 value = 0 } 
	set_variable = { which = upper_cap_04 value = 0 } 
	
	set_variable = { which = rural_now_05 value = 0 } set_variable = { which = urban_now_05 value = 0 } 
	set_variable = { which = upper_now_05 value = 0 } set_variable = { which = devel_now_05 value = 0 } 
	set_variable = { which = prov_size_05 value = 0 } set_variable = { which = total_cap_05 value = 0 } 
	set_variable = { which = rural_cap_05 value = 0 } set_variable = { which = urban_cap_05 value = 0 } 
	set_variable = { which = upper_cap_05 value = 0 } 
	
	# 6 to 10
	set_variable = { which = rural_now_06 value = 0 } set_variable = { which = urban_now_06 value = 0 } 
	set_variable = { which = upper_now_06 value = 0 } set_variable = { which = devel_now_06 value = 0 } 
	set_variable = { which = prov_size_06 value = 0 } set_variable = { which = total_cap_06 value = 0 } 
	set_variable = { which = rural_cap_06 value = 0 } set_variable = { which = urban_cap_06 value = 0 } 
	set_variable = { which = upper_cap_06 value = 0 } 
	
	set_variable = { which = rural_now_07 value = 0 } set_variable = { which = urban_now_07 value = 0 } 
	set_variable = { which = upper_now_07 value = 0 } set_variable = { which = devel_now_07 value = 0 } 
	set_variable = { which = prov_size_07 value = 0 } set_variable = { which = total_cap_07 value = 0 } 
	set_variable = { which = rural_cap_07 value = 0 } set_variable = { which = urban_cap_07 value = 0 } 
	set_variable = { which = upper_cap_07 value = 0 } 
	
	set_variable = { which = rural_now_08 value = 0 } set_variable = { which = urban_now_08 value = 0 } 
	set_variable = { which = upper_now_08 value = 0 } set_variable = { which = devel_now_08 value = 0 } 
	set_variable = { which = prov_size_08 value = 0 } set_variable = { which = total_cap_08 value = 0 } 
	set_variable = { which = rural_cap_08 value = 0 } set_variable = { which = urban_cap_08 value = 0 } 
	set_variable = { which = upper_cap_08 value = 0 } 
	
	set_variable = { which = rural_now_09 value = 0 } set_variable = { which = urban_now_09 value = 0 } 
	set_variable = { which = upper_now_09 value = 0 } set_variable = { which = devel_now_09 value = 0 } 
	set_variable = { which = prov_size_09 value = 0 } set_variable = { which = total_cap_09 value = 0 } 
	set_variable = { which = rural_cap_09 value = 0 } set_variable = { which = urban_cap_09 value = 0 } 
	set_variable = { which = upper_cap_09 value = 0 } 
	
	set_variable = { which = rural_now_10 value = 0 } set_variable = { which = urban_now_10 value = 0 } 
	set_variable = { which = upper_now_10 value = 0 } set_variable = { which = devel_now_10 value = 0 } 
	set_variable = { which = prov_size_10 value = 0 } set_variable = { which = total_cap_10 value = 0 } 
	set_variable = { which = rural_cap_10 value = 0 } set_variable = { which = urban_cap_10 value = 0 } 
	set_variable = { which = upper_cap_10 value = 0 } 
	
	# 11 to 15
	set_variable = { which = rural_now_11 value = 0 } set_variable = { which = urban_now_11 value = 0 } 
	set_variable = { which = upper_now_11 value = 0 } set_variable = { which = devel_now_11 value = 0 } 
	set_variable = { which = prov_size_11 value = 0 } set_variable = { which = total_cap_11 value = 0 } 
	set_variable = { which = rural_cap_11 value = 0 } set_variable = { which = urban_cap_11 value = 0 } 
	set_variable = { which = upper_cap_11 value = 0 } 
	
	set_variable = { which = rural_now_12 value = 0 } set_variable = { which = urban_now_12 value = 0 } 
	set_variable = { which = upper_now_12 value = 0 } set_variable = { which = devel_now_12 value = 0 } 
	set_variable = { which = prov_size_12 value = 0 } set_variable = { which = total_cap_12 value = 0 } 
	set_variable = { which = rural_cap_12 value = 0 } set_variable = { which = urban_cap_12 value = 0 } 
	set_variable = { which = upper_cap_12 value = 0 } 
	
	set_variable = { which = rural_now_13 value = 0 } set_variable = { which = urban_now_13 value = 0 } 
	set_variable = { which = upper_now_13 value = 0 } set_variable = { which = devel_now_13 value = 0 } 
	set_variable = { which = prov_size_13 value = 0 } set_variable = { which = total_cap_13 value = 0 } 
	set_variable = { which = rural_cap_13 value = 0 } set_variable = { which = urban_cap_13 value = 0 } 
	set_variable = { which = upper_cap_13 value = 0 } 
	
	set_variable = { which = rural_now_14 value = 0 } set_variable = { which = urban_now_14 value = 0 } 
	set_variable = { which = upper_now_14 value = 0 } set_variable = { which = devel_now_14 value = 0 } 
	set_variable = { which = prov_size_14 value = 0 } set_variable = { which = total_cap_14 value = 0 } 
	set_variable = { which = rural_cap_14 value = 0 } set_variable = { which = urban_cap_14 value = 0 } 
	set_variable = { which = upper_cap_14 value = 0 } 
	
	set_variable = { which = rural_now_15 value = 0 } set_variable = { which = urban_now_15 value = 0 } 
	set_variable = { which = upper_now_15 value = 0 } set_variable = { which = devel_now_15 value = 0 } 
	set_variable = { which = prov_size_15 value = 0 } set_variable = { which = total_cap_15 value = 0 } 
	set_variable = { which = rural_cap_15 value = 0 } set_variable = { which = urban_cap_15 value = 0 } 
	set_variable = { which = upper_cap_15 value = 0 } 
	
	# 16 to 20
	set_variable = { which = rural_now_16 value = 0 } set_variable = { which = urban_now_16 value = 0 } 
	set_variable = { which = upper_now_16 value = 0 } set_variable = { which = devel_now_16 value = 0 } 
	set_variable = { which = prov_size_16 value = 0 } set_variable = { which = total_cap_16 value = 0 } 
	set_variable = { which = rural_cap_16 value = 0 } set_variable = { which = urban_cap_16 value = 0 } 
	set_variable = { which = upper_cap_16 value = 0 } 
	
	set_variable = { which = rural_now_17 value = 0 } set_variable = { which = urban_now_17 value = 0 } 
	set_variable = { which = upper_now_17 value = 0 } set_variable = { which = devel_now_17 value = 0 } 
	set_variable = { which = prov_size_17 value = 0 } set_variable = { which = total_cap_17 value = 0 } 
	set_variable = { which = rural_cap_17 value = 0 } set_variable = { which = urban_cap_17 value = 0 } 
	set_variable = { which = upper_cap_17 value = 0 } 
	
	set_variable = { which = rural_now_18 value = 0 } set_variable = { which = urban_now_18 value = 0 } 
	set_variable = { which = upper_now_18 value = 0 } set_variable = { which = devel_now_18 value = 0 } 
	set_variable = { which = prov_size_18 value = 0 } set_variable = { which = total_cap_18 value = 0 } 
	set_variable = { which = rural_cap_18 value = 0 } set_variable = { which = urban_cap_18 value = 0 } 
	set_variable = { which = upper_cap_18 value = 0 } 
	
	set_variable = { which = rural_now_19 value = 0 } set_variable = { which = urban_now_19 value = 0 } 
	set_variable = { which = upper_now_19 value = 0 } set_variable = { which = devel_now_19 value = 0 } 
	set_variable = { which = prov_size_19 value = 0 } set_variable = { which = total_cap_19 value = 0 } 
	set_variable = { which = rural_cap_19 value = 0 } set_variable = { which = urban_cap_19 value = 0 } 
	set_variable = { which = upper_cap_19 value = 0 } 
	
	set_variable = { which = rural_now_20 value = 0 } set_variable = { which = urban_now_20 value = 0 } 
	set_variable = { which = upper_now_20 value = 0 } set_variable = { which = devel_now_20 value = 0 } 
	set_variable = { which = prov_size_20 value = 0 } set_variable = { which = total_cap_20 value = 0 } 
	set_variable = { which = rural_cap_20 value = 0 } set_variable = { which = urban_cap_20 value = 0 } 
	set_variable = { which = upper_cap_20 value = 0 } 
	
	# 21 to 25
	set_variable = { which = rural_now_21 value = 0 } set_variable = { which = urban_now_21 value = 0 } 
	set_variable = { which = upper_now_21 value = 0 } set_variable = { which = devel_now_21 value = 0 } 
	set_variable = { which = prov_size_21 value = 0 } set_variable = { which = total_cap_21 value = 0 } 
	set_variable = { which = rural_cap_21 value = 0 } set_variable = { which = urban_cap_21 value = 0 } 
	set_variable = { which = upper_cap_21 value = 0 } 
	
	set_variable = { which = rural_now_22 value = 0 } set_variable = { which = urban_now_22 value = 0 } 
	set_variable = { which = upper_now_22 value = 0 } set_variable = { which = devel_now_22 value = 0 } 
	set_variable = { which = prov_size_22 value = 0 } set_variable = { which = total_cap_22 value = 0 } 
	set_variable = { which = rural_cap_22 value = 0 } set_variable = { which = urban_cap_22 value = 0 } 
	set_variable = { which = upper_cap_22 value = 0 } 
	
	set_variable = { which = rural_now_23 value = 0 } set_variable = { which = urban_now_23 value = 0 } 
	set_variable = { which = upper_now_23 value = 0 } set_variable = { which = devel_now_23 value = 0 } 
	set_variable = { which = prov_size_23 value = 0 } set_variable = { which = total_cap_23 value = 0 } 
	set_variable = { which = rural_cap_23 value = 0 } set_variable = { which = urban_cap_23 value = 0 } 
	set_variable = { which = upper_cap_23 value = 0 } 
	
	set_variable = { which = rural_now_24 value = 0 } set_variable = { which = urban_now_24 value = 0 } 
	set_variable = { which = upper_now_24 value = 0 } set_variable = { which = devel_now_24 value = 0 } 
	set_variable = { which = prov_size_24 value = 0 } set_variable = { which = total_cap_24 value = 0 } 
	set_variable = { which = rural_cap_24 value = 0 } set_variable = { which = urban_cap_24 value = 0 } 
	set_variable = { which = upper_cap_24 value = 0 } 
	
	set_variable = { which = rural_now_25 value = 0 } set_variable = { which = urban_now_25 value = 0 } 
	set_variable = { which = upper_now_25 value = 0 } set_variable = { which = devel_now_25 value = 0 } 
	set_variable = { which = prov_size_25 value = 0 } set_variable = { which = total_cap_25 value = 0 } 
	set_variable = { which = rural_cap_25 value = 0 } set_variable = { which = urban_cap_25 value = 0 } 
	set_variable = { which = upper_cap_25 value = 0 } 
	
	set_variable = { which = rural_now_26 value = 0 } set_variable = { which = urban_now_26 value = 0 } 
	set_variable = { which = upper_now_26 value = 0 } set_variable = { which = devel_now_26 value = 0 } 
	set_variable = { which = prov_size_26 value = 0 } set_variable = { which = total_cap_26 value = 0 } 
	set_variable = { which = rural_cap_26 value = 0 } set_variable = { which = urban_cap_26 value = 0 } 
	set_variable = { which = upper_cap_26 value = 0 } 
	
}

##########
#	MIGRATION EFFECTS, the cornerstone of these mechanics. Hard to understand, but does wonders
##########

PG_update_inforange = {
	# Set main province's value, and compare
	export_to_variable = { which = tp_base value = province_trade_power } set_variable = { which = tp_compare which = tp_base }
	export_to_variable = { which = tp_infomod value = modifier:local_institution_spread } change_variable = { tp_infomod = 0.5 } # info: base -50%
	if = { limit = { check_variable = { tp_infomod = 0.9 } } set_variable = { which = tp_infomod value = 0.9 } } # max 90%, at least 10% attrition
	
	# Look at each of the neighbours values, and "compare" while updating
	every_neighbor_province = {
		export_to_variable = { which = tp_compare value = province_trade_power }  
		set_variable = { which = tp_infomod which = PREV } multiply_variable = { which = tp_compare which = tp_infomod } # use info % from base prov
		if = { limit = { check_variable = { which = tp_old which = tp_compare } } set_variable = { which = tp_compare which = tp_old } }
		if = {
			limit = { check_variable = { which = tp_compare which = PREV } }	# here which prev = the original province
			PREV = { set_variable = { which = tp_compare which = PREV } } 		# here which prev = the neighbor, so, moving the neighbors to you
		}
	}
	set_variable = { which = PG_info_range which = tp_compare } set_variable = { which = tp_old which = tp_compare }
	set_variable = { which = tp_infodisp which = tp_infomod } 	multiply_variable = { which = tp_old which = tp_infomod }
	# compare after passing all neighboring values (highest possible value). Final will be used for travel; old to check later on
	
}

PG_find_target_province = {
	if = {
		limit = { 
			any_province = {
				NOT = { province_distance = { who = PREV distance = $range$ } } check_variable = { urban_growth = 1.2 }
				NOT = { has_province_modifier = PG_new_pop }					province_has_center_of_trade_of_level = 4	# very high CoT
			}
		}
		random_province = {
			limit = {
				NOT = { province_distance = { who = PREV distance = $range$ } }	check_variable = { urban_growth = 1.2 }
				NOT = { has_province_modifier = PG_new_pop }					province_has_center_of_trade_of_level = 4
			}
			save_event_target_as = PG_target
		}
	}
	else_if = {
		limit = { 
			any_province = {
				NOT = { province_distance = { who = PREV distance = $range$ } } check_variable = { urban_growth = 1.2 }
				NOT = { has_province_modifier = PG_new_pop }					province_has_center_of_trade_of_level = 2	# "normal" CoT
			}
		}
		random_province = {
			limit = {
				NOT = { province_distance = { who = PREV distance = $range$ } }	check_variable = { urban_growth = 1.2 }
				NOT = { has_province_modifier = PG_new_pop }					province_has_center_of_trade_of_level = 2
			}
			save_event_target_as = PG_target
		}
	}
	else_if = {
		limit = { 
			any_province = {
				NOT = { province_distance = { who = PREV distance = $range$ } } NOT = { has_province_modifier = PG_new_pop } # any other place
				OR = { check_variable = { rural_growth = 1.2 } check_variable = { urban_growth = 1.2 } }
			}
		}
		random_province = {
			limit = {
				NOT = { province_distance = { who = PREV distance = $range$ } } NOT = { has_province_modifier = PG_new_pop }
				OR = { check_variable = { rural_growth = 1.2 } check_variable = { urban_growth = 1.2 } }			
			}
			save_event_target_as = PG_target
		}
	}
	else = { 	# nowhere to go -> starvation! 
		set_province_flag = PG_starvation_start
	}

}

mig_dist_cost = {
	if = { 		limit = { province_distance = { who = PREV distance = 1200 } } 	PREV = { owner = { add_treasury = -100 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 750 } } 	PREV = { owner = { add_treasury = -70 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 500 } } 	PREV = { owner = { add_treasury = -60 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 400 } } 	PREV = { owner = { add_treasury = -50 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 300 } } 	PREV = { owner = { add_treasury = -40 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 200 } } 	PREV = { owner = { add_treasury = -30 } } }
	else_if = { limit = { province_distance = { who = PREV distance = 120 } } 	PREV = { owner = { add_treasury = -20 } } }
	else = { 																	PREV = { owner = { add_treasury = -10 } } }
	
}

mig_rural_to_urban = {
	PREV = { subtract_variable = { which = mig_size value = $no$ } add_base_manpower = -$no$ 	change_variable = { PGS_rur_emig = $no$ } }
	add_base_production = $no$ 	add_province_modifier = { name = pg_new_pop duration = 365 }	change_variable = { PGS_urb_imig = $no$ }
	
}

mig_rural_to_rural = {
	PREV = { subtract_variable = { which = mig_size value = $no$ } add_base_manpower = -$no$  	change_variable = { PGS_rur_emig = $no$ } }
	add_base_manpower = $no$ 	add_province_modifier = { name = pg_new_pop duration = 365 }	change_variable = { PGS_urb_imig = $no$ }
	
}

##########
#	STATISTICS EFFECTS, yes, we love statistics! Here go all the code that aggregates the information in your save game
##########

popgrowth_stats_basic = {

	export_to_variable = { which = rural_now_$regid$ value = base_manpower } set_variable = { which = total_cap_$regid$ which = rural_capacity }
	export_to_variable = { which = urban_now_$regid$ value = base_production } change_variable = { which = total_cap_$regid$ which = urban_capacity }
	export_to_variable = { which = upper_now_$regid$ value = base_tax } 		change_variable = { which = total_cap_$regid$ which = upper_capacity }
	export_to_variable = { which = devel_now_$regid$ value = development }
	set_variable = { which = rural_cap_$regid$ which = rural_capacity } set_variable = { which = urban_cap_$regid$ which = urban_capacity }
	set_variable = { which = upper_cap_$regid$ which = upper_capacity } set_variable = { which = prov_size_$regid$ which = prov_size } 
	ROOT = { 
		change_variable = { which = rural_now_$regid$ which = PREV } change_variable = { which = urban_now_$regid$ which = PREV } 
		change_variable = { which = upper_now_$regid$ which = PREV } change_variable = { which = devel_now_$regid$ which = PREV } 
		change_variable = { which = prov_size_$regid$ which = PREV } change_variable = { which = total_cap_$regid$ which = PREV } 
		change_variable = { which = rural_cap_$regid$ which = PREV } change_variable = { which = urban_cap_$regid$ which = PREV } 
		change_variable = { which = upper_cap_$regid$ which = PREV } 
	}

}


popgrowth_stats_old = {
	
	# 1: show current values, storing the capacities in a new name (oldcap instead of cap)
	set_variable = { which = rural_old which = rural_capacity }	
	set_variable = { which = urban_old which = urban_capacity }	
	set_variable = { which = upper_old which = upper_capacity }	
	set_variable = { which = rural_oldcap_$regid$ which = rural_capacity }	
	set_variable = { which = urban_oldcap_$regid$ which = urban_capacity }	
	set_variable = { which = upper_oldcap_$regid$ which = upper_capacity }	
	set_variable = { which = total_oldcap_$regid$ which = rural_capacity }	
	change_variable = { which = total_oldcap_$regid$ which = urban_capacity }
	change_variable = { which = total_oldcap_$regid$ which = upper_capacity }
	
	export_to_variable = { which = devold_$regid$ value = base_manpower }
	export_to_variable = { which = urban_devold_$regid$ value = base_production }
	export_to_variable = { which = upper_devold_$regid$ value = base_tax } 	
	change_variable = { which = devold_$regid$ which = urban_devold_$regid$ } set_variable = { which = urban_devold_$regid$ value = 0 }
	change_variable = { which = devold_$regid$ which = upper_devold_$regid$ } set_variable = { which = upper_devold_$regid$ value = 0 }
	
	set_variable = { which = total_new_$regid$ which = total_cap_$regid$ }
	
	set_variable = { which = rural_cap_$regid$ which = rural_capacity } set_variable = { which = urban_cap_$regid$ which = urban_capacity }
	set_variable = { which = upper_cap_$regid$ which = upper_capacity } set_variable = { which = prov_size_$regid$ which = prov_size } 
	ROOT = {
		change_variable = { which = total_old_$regid$ which = PREV } 	change_variable = { which = rural_old_$regid$ which = PREV } 
		change_variable = { which = urban_old_$regid$ which = PREV } 	change_variable = { which = upper_old_$regid$ which = PREV } 
		change_variable = { which = devold_$regid$ which = PREV }
	}

}

adjust_pops_to_max = {
	export_to_variable = { which = rural_now value = base_manpower }	subtract_variable = { which = rural_now which = rural_capacity }
	export_to_variable = { which = urban_now value = base_production }	subtract_variable = { which = urban_now which = urban_capacity }
	export_to_variable = { which = upper_now value = base_tax }			subtract_variable = { which = upper_now which = upper_capacity }

	while = {
		limit = { check_variable = { rural_now = 1 } }		# as long as more rural pop compared to the (new) capacity -> pop to remove
		subtract_variable = { rural_now = 1 }
		add_base_manpower = -1
	}
	while = {
		limit = { check_variable = { urban_now = 1 } }		
		subtract_variable = { urban_now = 1 }
		add_base_production = -1
	}
	while = {
		limit = { check_variable = { upper_now = 1 } }		
		subtract_variable = { upper_now = 1 }
		add_base_tax = -1
	}
	
}





